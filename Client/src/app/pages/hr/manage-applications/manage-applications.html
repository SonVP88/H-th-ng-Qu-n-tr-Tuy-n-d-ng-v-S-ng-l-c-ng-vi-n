<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Qu·∫£n l√Ω h·ªì s∆° ·ª©ng tuy·ªÉn</h1>
        <p class="text-gray-600">Xem v√† qu·∫£n l√Ω c√°c h·ªì s∆° ·ª©ng vi√™n cho v·ªã tr√≠ tuy·ªÉn d·ª•ng</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="space-y-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 animate-pulse">
            <div class="flex items-center gap-4">
                <div class="h-12 w-12 rounded-full bg-gray-200"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                    <div class="h-3 bg-gray-200 rounded w-1/3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div *ngIf="!isLoading && !isEmpty" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ·ª®ng vi√™n
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ng√†y n·ªôp
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            AI Match
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            CV
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Tr·∫°ng th√°i
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            H√†nh ƒë·ªông
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr *ngFor="let app of applications" class="hover:bg-gray-50 transition-colors">
                        <!-- Candidate Info -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-blue-700 font-semibold text-sm">{{
                                            app.candidateName.charAt(0).toUpperCase() }}</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ app.candidateName }}</div>
                                    <div class="text-sm text-gray-500">{{ app.email }}</div>
                                    <div class="text-xs text-gray-400" *ngIf="app.phone">{{ app.phone }}</div>
                                </div>
                            </div>
                        </td>

                        <!-- Applied Date -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ formatDate(app.appliedAt) }}</div>
                        </td>

                        <!-- AI Match Score -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div *ngIf="app.matchScore" [ngClass]="getScoreColor(app.matchScore)"
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border"
                                [title]="app.aiExplanation || ''">
                                {{ app.matchScore }}%
                            </div>
                            <span *ngIf="!app.matchScore" class="text-gray-400 text-sm">-</span>
                        </td>

                        <!-- CV -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button (click)="viewCv(app.cvUrl)"
                                class="text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-1">
                                <span class="material-symbols-outlined" style="font-size: 18px;">description</span>
                                Xem
                            </button>
                        </td>

                        <!-- Status -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span [ngClass]="getStatusClass(app.status)">
                                {{ getStatusLabel(app.status) }}
                            </span>
                        </td>

                        <!-- Actions -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center gap-2">
                                <!-- Tr∆∞·ªùng h·ª£p 1: NEW_APPLIED ho·∫∑c ACTIVE -->
                                <ng-container *ngIf="app.status === 'NEW_APPLIED' || app.status === 'ACTIVE'">
                                    <button (click)="updateStatus(app.applicationId, 'INTERVIEW')"
                                        class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-semibold flex items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">event</span>
                                        M·ªùi Ph·ªèng v·∫•n
                                    </button>
                                    <button (click)="updateStatus(app.applicationId, 'REJECTED')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-xs font-semibold flex items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">close</span>
                                        Lo·∫°i h·ªì s∆°
                                    </button>
                                </ng-container>

                                <!-- Tr∆∞·ªùng h·ª£p 2: INTERVIEW (ƒë√£ m·ªùi ph·ªèng v·∫•n, ch·ªù k·∫øt qu·∫£) -->
                                <ng-container *ngIf="app.status === 'INTERVIEW'">
                                    <button (click)="updateStatus(app.applicationId, 'HIRED')"
                                        class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-xs font-semibold flex items-center gap-1">
                                        <span class="material-symbols-outlined"
                                            style="font-size: 14px;">check_circle</span>
                                        ‚úÖ Duy·ªát (Pass)
                                    </button>
                                    <button (click)="updateStatus(app.applicationId, 'REJECTED')"
                                        class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs font-semibold flex items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">cancel</span>
                                        ‚ùå T·ª´ ch·ªëi (Fail)
                                    </button>
                                </ng-container>

                                <!-- Tr∆∞·ªùng h·ª£p 3: HIRED ho·∫∑c REJECTED (ƒë√£ ho√†n t·∫•t) -->
                                <ng-container *ngIf="app.status === 'HIRED' || app.status === 'REJECTED'">
                                    <span class="text-gray-500 text-xs italic flex items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">check</span>
                                        ƒê√£ ho√†n t·∫•t
                                    </span>
                                </ng-container>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!isLoading && hasError" class="bg-white rounded-xl shadow-sm border border-red-200 p-12 text-center">
        <div class="flex flex-col items-center gap-4">
            <div class="w-24 h-24 rounded-full bg-red-50 flex items-center justify-center">
                <span class="material-symbols-outlined text-red-500" style="font-size: 48px;">error</span>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">L·ªói</h3>
                <p class="text-gray-600 text-sm">{{ errorMessage }}</p>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && !hasError && isEmpty"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
        <div class="flex flex-col items-center gap-4">
            <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-gray-400" style="font-size: 48px;">inbox</span>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Ch∆∞a c√≥ h·ªì s∆° n√†o</h3>
                <p class="text-gray-500 text-sm">Ch∆∞a c√≥ ·ª©ng vi√™n n√†o n·ªôp h·ªì s∆° cho v·ªã tr√≠ n√†y</p>
            </div>
        </div>
    </div>

    <!-- Modal L√™n L·ªãch Ph·ªèng V·∫•n -->
    <div *ngIf="showInterviewModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-600">calendar_month</span>
                    L√™n L·ªãch Ph·ªèng V·∫•n
                </h2>
                <button (click)="closeInterviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Th√¥ng tin ·ª©ng vi√™n -->
                <div class="bg-blue-50 rounded-lg p-4 flex items-center gap-4">
                    <div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center">
                        <span class="text-blue-700 font-bold text-lg">{{
                            selectedApplication?.candidateName?.charAt(0)?.toUpperCase() }}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900">{{ selectedApplication?.candidateName }}</p>
                        <p class="text-sm text-gray-600">{{ selectedApplication?.email }}</p>
                    </div>
                </div>

                <!-- Form nh·∫≠p th√¥ng tin ph·ªèng v·∫•n -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Ng√†y ph·ªèng v·∫•n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y ph·ªèng v·∫•n *</label>
                        <input type="date" [(ngModel)]="interviewForm.date" (ngModelChange)="updateEmailPreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Gi·ªù ph·ªèng v·∫•n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gi·ªù ph·ªèng v·∫•n *</label>
                        <input type="time" [(ngModel)]="interviewForm.time" (ngModelChange)="updateEmailPreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- H√¨nh th·ª©c -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">H√¨nh th·ª©c *</label>
                        <select [(ngModel)]="interviewForm.type" (ngModelChange)="updateEmailPreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="ONLINE">Online (Video Call)</option>
                            <option value="OFFLINE">Offline (Tr·ª±c ti·∫øp)</option>
                        </select>
                    </div>

                    <!-- Link/ƒê·ªãa ƒëi·ªÉm -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ interviewForm.type === 'ONLINE' ? 'Link Meeting *' : 'ƒê·ªãa ƒëi·ªÉm *' }}
                        </label>
                        <input type="text" [(ngModel)]="interviewForm.location" (ngModelChange)="updateEmailPreview()"
                            [placeholder]="interviewForm.type === 'ONLINE' ? 'VD: https://meet.google.com/xxx' : 'VD: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM'"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Khu v·ª±c Email Preview -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <!-- Header Email Preview -->
                    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-600">mail</span>
                            <span class="font-medium text-gray-700">So·∫°n th·∫£o Email Preview</span>
                        </div>
                        <button (click)="generateAIOpening()" [disabled]="isGeneratingAI"
                            class="px-4 py-2 bg-gradient-to-r from-yellow-400 to-amber-500 text-white rounded-lg hover:from-yellow-500 hover:to-amber-600 transition-all font-semibold text-sm flex items-center gap-2 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                            <span *ngIf="!isGeneratingAI">‚ú®</span>
                            <span *ngIf="isGeneratingAI" class="animate-spin">‚è≥</span>
                            {{ isGeneratingAI ? 'ƒêang t·∫°o...' : 'AI Personalize' }}
                        </button>
                    </div>

                    <!-- Textarea Email -->
                    <div class="p-4">
                        <textarea [(ngModel)]="emailPreviewContent" rows="10"
                            placeholder="N·ªôi dung email s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y..."
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none font-mono text-sm leading-relaxed"></textarea>
                        <p class="text-xs text-gray-500 mt-2">
                            üí° B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·ªôi dung email tr∆∞·ªõc khi g·ª≠i. B·∫•m "‚ú® AI Personalize" ƒë·ªÉ t·∫°o ƒëo·∫°n m·ªü
                            ƒë·∫ßu c√° nh√¢n h√≥a.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button (click)="closeInterviewModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                    H·ªßy
                </button>
                <button (click)="sendInterviewInvitation()" [disabled]="isSendingEmail || !isFormValid()"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span *ngIf="!isSendingEmail" class="material-symbols-outlined" style="font-size: 18px;">send</span>
                    <span *ngIf="isSendingEmail" class="animate-spin">‚è≥</span>
                    {{ isSendingEmail ? 'ƒêang g·ª≠i...' : 'G·ª≠i l·ªùi m·ªùi' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Modal T·ª´ Ch·ªëi H·ªì S∆° -->
    <div *ngIf="showRejectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <span class="material-symbols-outlined text-red-500">cancel</span>
                    T·ª´ Ch·ªëi H·ªì S∆°
                </h2>
                <button (click)="closeRejectModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Th√¥ng tin ·ª©ng vi√™n -->
                <div class="bg-red-50 rounded-lg p-4 flex items-center gap-4">
                    <div class="h-12 w-12 rounded-full bg-red-100 flex items-center justify-center">
                        <span class="text-red-700 font-bold text-lg">{{
                            rejectApplication?.candidateName?.charAt(0)?.toUpperCase() }}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900">{{ rejectApplication?.candidateName }}</p>
                        <p class="text-sm text-gray-600">{{ rejectApplication?.email }}</p>
                    </div>
                </div>

                <!-- B∆∞·ªõc 1: Input l√Ω do t·ª´ ch·ªëi -->
                <div *ngIf="rejectStep === 1" class="space-y-4">
                    <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-sm">B∆∞·ªõc 1</span>
                        Ch·ªçn l√Ω do t·ª´ ch·ªëi
                    </h3>

                    <!-- Checkboxes -->
                    <div class="space-y-3">
                        <label
                            class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" [(ngModel)]="rejectReasons.skill"
                                class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                            <span class="text-gray-700">Chuy√™n m√¥n ch∆∞a ƒë·∫°t</span>
                        </label>

                        <label
                            class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" [(ngModel)]="rejectReasons.salary"
                                class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                            <span class="text-gray-700">M·ª©c l∆∞∆°ng kh√¥ng ph√π h·ª£p</span>
                        </label>

                        <label
                            class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" [(ngModel)]="rejectReasons.culture"
                                class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                            <span class="text-gray-700">VƒÉn h√≥a kh√¥ng ph√π h·ª£p</span>
                        </label>
                    </div>

                    <!-- Ghi ch√∫ th√™m -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ghi ch√∫ th√™m cho AI</label>
                        <input type="text" [(ngModel)]="rejectNote"
                            placeholder="VD: Nh·∫π nh√†ng th√¥i, ƒë·ªông vi√™n h·ªç l·∫ßn sau..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>

                    <!-- N√∫t T·∫°o Draft -->
                    <button (click)="generateRejectionDraft()"
                        [disabled]="isGeneratingRejectEmail || !hasSelectedReason()"
                        class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all font-semibold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span *ngIf="!isGeneratingRejectEmail">ü§ñ</span>
                        <span *ngIf="isGeneratingRejectEmail" class="animate-spin">‚è≥</span>
                        {{ isGeneratingRejectEmail ? 'AI ƒëang so·∫°n email...' : 'T·∫°o Email nh√°p (AI Draft)' }}
                    </button>
                </div>

                <!-- B∆∞·ªõc 2: Review & Edit Email -->
                <div *ngIf="rejectStep === 2" class="space-y-4">
                    <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                        <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-sm">B∆∞·ªõc 2</span>
                        Xem l·∫°i & Ch·ªânh s·ª≠a Email
                    </h3>

                    <!-- Email Preview -->
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-600">mail</span>
                            <span class="text-sm font-medium text-gray-700">N·ªôi dung Email T·ª´ Ch·ªëi</span>
                        </div>
                        <textarea [(ngModel)]="rejectEmailContent" rows="12"
                            class="w-full px-4 py-3 border-0 focus:ring-0 resize-none font-mono text-sm leading-relaxed"></textarea>
                    </div>

                    <p class="text-xs text-gray-500">
                        ‚úèÔ∏è B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·ªôi dung email tr∆∞·ªõc khi g·ª≠i. N·ªôi dung s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: <strong>{{
                            rejectApplication?.email }}</strong>
                    </p>

                    <!-- N√∫t quay l·∫°i -->
                    <button (click)="rejectStep = 1"
                        class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
                        <span class="material-symbols-outlined" style="font-size: 16px;">arrow_back</span>
                        Quay l·∫°i ch·ªçn l√Ω do
                    </button>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button (click)="closeRejectModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                    H·ªßy
                </button>
                <button *ngIf="rejectStep === 2" (click)="confirmReject()" [disabled]="isSendingRejectEmail"
                    class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span *ngIf="!isSendingRejectEmail" class="material-symbols-outlined"
                        style="font-size: 18px;">send</span>
                    <span *ngIf="isSendingRejectEmail" class="animate-spin">‚è≥</span>
                    {{ isSendingRejectEmail ? 'ƒêang g·ª≠i...' : 'G·ª≠i Email T·ª´ Ch·ªëi' }}
                </button>
            </div>
        </div>
    </div>
</div>