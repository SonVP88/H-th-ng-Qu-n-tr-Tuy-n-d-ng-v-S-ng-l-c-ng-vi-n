<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Qu·∫£n l√Ω h·ªì s∆° ·ª©ng tuy·ªÉn</h1>
        <p class="text-gray-600">Xem v√† qu·∫£n l√Ω c√°c h·ªì s∆° ·ª©ng vi√™n cho v·ªã tr√≠ tuy·ªÉn d·ª•ng</p>
    </div>

    <!-- Search/Filter/Export Toolbar -->
    <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex flex-wrap items-center gap-4">
            <!-- Search Box -->
            <div class="flex-1 min-w-[300px]">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" [(ngModel)]="searchQuery" (input)="onSearchChange()"
                        placeholder="T√¨m ki·∫øm theo t√™n ho·∫∑c email..."
                        class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                </div>
            </div>

            <!-- Filter Button -->
            <button (click)="toggleFilterPanel()"
                class="inline-flex items-center gap-2 px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                B·ªô l·ªçc
                <span *ngIf="getActiveFiltersCount() > 0"
                    class="ml-1 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">
                    {{ getActiveFiltersCount() }}
                </span>
            </button>

            <!-- Refresh Button -->
            <button (click)="refreshApplications()"
                class="inline-flex items-center gap-2 px-4 py-2.5 bg-gray-600 text-white rounded-lg text-sm font-medium hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                L√†m m·ªõi
            </button>

            <!-- Export Button -->
            <button (click)="exportToExcel()" [disabled]="filteredApplications().length === 0"
                class="inline-flex items-center gap-2 px-4 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Xu·∫•t file
            </button>
        </div>

        <!-- Filter Panel (Collapsible) -->
        <div *ngIf="showFilterPanel" class="mt-4 pt-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tr·∫°ng th√°i</label>
                    <select [(ngModel)]="filterStatus" (change)="applyFilters()"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="NEW">M·ªõi n·ªôp</option>
                        <option value="SCREENING">S√†ng l·ªçc</option>
                        <option value="INTERVIEW">Ph·ªèng v·∫•n</option>
                        <option value="OFFER">ƒê·ªÅ ngh·ªã</option>
                        <option value="HIRED">ƒê√£ tuy·ªÉn</option>
                        <option value="REJECTED">T·ª´ ch·ªëi</option>
                    </select>
                </div>

                <!-- AI Score Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI Match Score</label>
                    <select [(ngModel)]="filterScoreRange" (change)="applyFilters()"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="90-100">Xu·∫•t s·∫Øc (90-100%)</option>
                        <option value="75-89">T·ªët (75-89%)</option>
                        <option value="50-74">Trung b√¨nh (50-74%)</option>
                        <option value="0-49">Th·∫•p (<50%)< /option>
                    </select>
                </div>

                <!-- Date Range Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ng√†y n·ªôp</label>
                    <select [(ngModel)]="filterDateRange" (change)="applyFilters()"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="today">H√¥m nay</option>
                        <option value="week">7 ng√†y qua</option>
                        <option value="month">30 ng√†y qua</option>
                        <option value="custom">T√πy ch·ªânh</option>
                    </select>
                </div>
            </div>

            <!-- Clear Filters Button -->
            <div class="mt-4 flex justify-end">
                <button (click)="clearFilters()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                    X√≥a t·∫•t c·∫£ b·ªô l·ªçc
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="space-y-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 animate-pulse">
            <div class="flex items-center gap-4">
                <div class="h-12 w-12 rounded-full bg-gray-200"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                    <div class="h-3 bg-gray-200 rounded w-1/3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div *ngIf="!isLoading && !isEmpty" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ·ª®ng vi√™n
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ng√†y n·ªôp
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            AI Match
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            CV
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Tr·∫°ng th√°i
                        </th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            H√†nh ƒë·ªông
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr *ngFor="let app of filteredApplications()" class="hover:bg-gray-50 transition-colors">
                        <!-- Candidate Info -->
                        <td class="px-6 py-4 whitespace-nowrap cursor-pointer" (click)="viewCandidateDetail(app)">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-blue-700 font-semibold text-sm">{{
                                            app.candidateName.charAt(0).toUpperCase() }}</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ app.candidateName }}</div>
                                    <div class="text-sm text-gray-500">{{ app.email }}</div>
                                    <div class="text-xs text-gray-400" *ngIf="app.phone">{{ app.phone }}</div>
                                </div>
                            </div>
                        </td>

                        <!-- Applied Date -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ formatDate(app.appliedAt) }}</div>
                        </td>

                        <!-- AI Match Score -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div *ngIf="app.matchScore" [ngClass]="getScoreColor(app.matchScore)"
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border"
                                [title]="app.aiExplanation || ''">
                                {{ app.matchScore }}%
                            </div>
                            <span *ngIf="!app.matchScore" class="text-gray-400 text-sm">-</span>
                        </td>

                        <!-- CV -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <button (click)="viewCv(app.cvUrl); $event.stopPropagation()"
                                class="text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-1">
                                <span class="material-symbols-outlined" style="font-size: 18px;">description</span>
                                Xem
                            </button>
                        </td>

                        <!-- Status -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span [ngClass]="getStatusClass(app.status)">
                                {{ getStatusLabel(app.status) }}
                            </span>
                        </td>

                        <!-- Actions -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center gap-2">
                                <!-- Tr∆∞·ªùng h·ª£p 1: NEW_APPLIED ho·∫∑c ACTIVE -->
                                <ng-container *ngIf="app.status === 'NEW_APPLIED' || app.status === 'ACTIVE'">
                                    <button
                                        (click)="updateStatus(app.applicationId, 'INTERVIEW'); $event.stopPropagation()"
                                        class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-semibold flex items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">event</span>
                                        üìÖ M·ªùi Ph·ªèng v·∫•n
                                    </button>
                                    <button
                                        (click)="updateStatus(app.applicationId, 'REJECTED'); $event.stopPropagation()"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-xs font-semibold flex items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">close</span>
                                        Lo·∫°i h·ªì s∆°
                                    </button>
                                </ng-container>

                                <!-- Tr∆∞·ªùng h·ª£p 2: INTERVIEW (ƒê√£ m·ªùi PV - Ch·ªù Interviewer ƒë√°nh gi√°) -->
                                <ng-container *ngIf="app.status === 'INTERVIEW'">
                                    <span
                                        class="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-xs font-medium flex items-center gap-1 border border-blue-200">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">schedule</span>
                                        ƒê√£ m·ªùi PV - Ch·ªù ƒë√°nh gi√°
                                    </span>
                                </ng-container>

                                <!-- Tr∆∞·ªùng h·ª£p 3: PENDING_OFFER (PV Pass - Ch·ªù g·ª≠i offer) -->
                                <ng-container *ngIf="app.status === 'Pending_Offer'">
                                    <button (click)="openOfferModal(app); $event.stopPropagation()"
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-xs font-semibold flex items-center gap-2 shadow-sm">
                                        <span class="material-symbols-outlined" style="font-size: 16px;">mail</span>
                                        üìß G·ª≠i Offer
                                    </button>
                                </ng-container>

                                <!-- Tr∆∞·ªùng h·ª£p 4: OFFER_SENT (ƒê√£ g·ª≠i offer - Ch·ªù ph·∫£n h·ªìi) -->
                                <ng-container *ngIf="app.status === 'Offer_Sent'">
                                    <span
                                        class="px-3 py-1.5 bg-green-50 text-green-700 rounded-lg text-xs font-medium flex items-center gap-1 border border-green-200">
                                        <span class="material-symbols-outlined"
                                            style="font-size: 14px;">mail_outline</span>
                                        ƒê√£ g·ª≠i Offer - Ch·ªù ph·∫£n h·ªìi
                                    </span>
                                </ng-container>

                                <!-- Tr∆∞·ªùng h·ª£p 5: HIRED ho·∫∑c REJECTED (ƒê√£ ho√†n t·∫•t) -->
                                <ng-container *ngIf="app.status === 'HIRED' || app.status === 'REJECTED'">
                                    <span class="text-gray-500 text-xs italic flex items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">check</span>
                                        ƒê√£ ho√†n t·∫•t
                                    </span>
                                </ng-container>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!isLoading && hasError" class="bg-white rounded-xl shadow-sm border border-red-200 p-12 text-center">
        <div class="flex flex-col items-center gap-4">
            <div class="w-24 h-24 rounded-full bg-red-50 flex items-center justify-center">
                <span class="material-symbols-outlined text-red-500" style="font-size: 48px;">error</span>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">L·ªói</h3>
                <p class="text-gray-600 text-sm">{{ errorMessage }}</p>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && !hasError && isEmpty"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center">
        <div class="flex flex-col items-center gap-4">
            <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-gray-400" style="font-size: 48px;">inbox</span>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Ch∆∞a c√≥ h·ªì s∆° n√†o</h3>
                <p class="text-gray-500 text-sm">Ch∆∞a c√≥ ·ª©ng vi√™n n√†o n·ªôp h·ªì s∆° cho v·ªã tr√≠ n√†y</p>
            </div>
        </div>
    </div>

    <!-- Modal L√™n L·ªãch Ph·ªèng V·∫•n -->
    <div *ngIf="showInterviewModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-600">calendar_month</span>
                    L√™n L·ªãch Ph·ªèng V·∫•n
                </h2>
                <button (click)="closeInterviewModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Th√¥ng tin ·ª©ng vi√™n -->
                <div class="bg-blue-50 rounded-lg p-4 flex items-center gap-4">
                    <div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center">
                        <span class="text-blue-700 font-bold text-lg">{{
                            selectedApplication?.candidateName?.charAt(0)?.toUpperCase() }}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900">{{ selectedApplication?.candidateName }}</p>
                        <p class="text-sm text-gray-600">{{ selectedApplication?.email }}</p>
                    </div>
                </div>

                <!-- Form nh·∫≠p th√¥ng tin ph·ªèng v·∫•n -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Ng√†y ph·ªèng v·∫•n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y ph·ªèng v·∫•n *</label>
                        <input type="date" [(ngModel)]="interviewForm.date" (ngModelChange)="updateEmailPreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Gi·ªù ph·ªèng v·∫•n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gi·ªù ph·ªèng v·∫•n *</label>
                        <input type="time" [(ngModel)]="interviewForm.time" (ngModelChange)="updateEmailPreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Custom Dropdown - Ng∆∞·ªùi ph·ªèng v·∫•n -->
                    <div class="md:col-span-2 relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Ng∆∞·ªùi ph·ªèng v·∫•n (Interviewer) *
                        </label>

                        <!-- Dropdown Button -->
                        <button type="button" (click)="toggleDropdown()" [disabled]="isLoadingInterviewers"
                            class="w-full px-4 py-2.5 text-left border border-gray-300 rounded-lg bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed transition-all flex items-center justify-between">
                            <span [class.text-gray-400]="!interviewForm.interviewerId"
                                [class.text-gray-900]="interviewForm.interviewerId">
                                {{ isLoadingInterviewers ? 'ƒêang t·∫£i...' : (getSelectedInterviewerName() || '-- Ch·ªçn
                                ng∆∞·ªùi ph·ªèng v·∫•n --') }}
                            </span>
                            <svg class="w-5 h-5 text-gray-400 transition-transform" [class.rotate-180]="isDropdownOpen"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <!-- Dropdown Panel -->
                        <div *ngIf="isDropdownOpen"
                            class="absolute z-50 mt-2 w-full bg-white rounded-lg shadow-xl border border-gray-200 max-h-96 overflow-hidden">

                            <!-- Search Box -->
                            <div class="p-3 border-b border-gray-200">
                                <div class="relative">
                                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <input type="text" [(ngModel)]="dropdownSearchQuery" placeholder="T√¨m ki·∫øm..."
                                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>

                            <!-- Scrollable List -->
                            <div class="overflow-y-auto max-h-80">

                                <!-- ADMIN Group -->
                                <div *ngIf="hasInterviewersWithRole('ADMIN')" class="border-b border-gray-100">
                                    <!-- Group Header -->
                                    <button type="button" (click)="toggleGroup('ADMIN')"
                                        class="w-full px-4 py-2.5 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors">
                                        <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                            <span class="text-base">üëë</span> ADMIN
                                        </span>
                                        <svg class="w-4 h-4 text-gray-500 transition-transform"
                                            [class.rotate-180]="expandedGroups.ADMIN" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <!-- Group Items -->
                                    <div *ngIf="expandedGroups.ADMIN" class="bg-white">
                                        <button type="button"
                                            *ngFor="let user of getFilteredInterviewersByRole('ADMIN')"
                                            (click)="selectInterviewer(user)"
                                            [class.bg-blue-50]="interviewForm.interviewerId === user.id"
                                            class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left">
                                            <div
                                                [class]="'w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm ' + getAvatarColor(user.fullName)">
                                                {{ getInitials(user.fullName) }}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-medium text-gray-900 truncate">{{ user.fullName
                                                    }}</div>
                                                <div class="text-xs text-gray-500 truncate">{{ user.email }}</div>
                                            </div>
                                            <svg *ngIf="interviewForm.interviewerId === user.id"
                                                class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </button>
                                        <div *ngIf="getFilteredInterviewersByRole('ADMIN').length === 0"
                                            class="px-4 py-3 text-sm text-gray-500 text-center">
                                            Kh√¥ng t√¨m th·∫•y
                                        </div>
                                    </div>
                                </div>

                                <!-- HR Group -->
                                <div *ngIf="hasInterviewersWithRole('HR')" class="border-b border-gray-100">
                                    <button type="button" (click)="toggleGroup('HR')"
                                        class="w-full px-4 py-2.5 flex items-center justify-between bg-blue-50 hover:bg-blue-100 transition-colors">
                                        <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                            <span class="text-base"></span> HR MANAGER
                                        </span>
                                        <svg class="w-4 h-4 text-gray-500 transition-transform"
                                            [class.rotate-180]="expandedGroups.HR" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div *ngIf="expandedGroups.HR" class="bg-white">
                                        <button type="button" *ngFor="let user of getFilteredInterviewersByRole('HR')"
                                            (click)="selectInterviewer(user)"
                                            [class.bg-blue-50]="interviewForm.interviewerId === user.id"
                                            class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left">
                                            <div
                                                [class]="'w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm ' + getAvatarColor(user.fullName)">
                                                {{ getInitials(user.fullName) }}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-medium text-gray-900 truncate">{{ user.fullName
                                                    }}</div>
                                                <div class="text-xs text-gray-500 truncate">{{ user.email }}</div>
                                            </div>
                                            <svg *ngIf="interviewForm.interviewerId === user.id"
                                                class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </button>
                                        <div *ngIf="getFilteredInterviewersByRole('HR').length === 0"
                                            class="px-4 py-3 text-sm text-gray-500 text-center">
                                            Kh√¥ng t√¨m th·∫•y
                                        </div>
                                    </div>
                                </div>

                                <!-- INTERVIEWER Group -->
                                <div *ngIf="hasInterviewersWithRole('INTERVIEWER')">
                                    <button type="button" (click)="toggleGroup('INTERVIEWER')"
                                        class="w-full px-4 py-2.5 flex items-center justify-between bg-purple-50 hover:bg-purple-100 transition-colors">
                                        <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                            <span class="text-base"></span> INTERVIEWER
                                        </span>
                                        <svg class="w-4 h-4 text-gray-500 transition-transform"
                                            [class.rotate-180]="expandedGroups.INTERVIEWER" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div *ngIf="expandedGroups.INTERVIEWER" class="bg-white">
                                        <button type="button"
                                            *ngFor="let user of getFilteredInterviewersByRole('INTERVIEWER')"
                                            (click)="selectInterviewer(user)"
                                            [class.bg-blue-50]="interviewForm.interviewerId === user.id"
                                            class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left">
                                            <div
                                                [class]="'w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm ' + getAvatarColor(user.fullName)">
                                                {{ getInitials(user.fullName) }}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-medium text-gray-900 truncate">{{ user.fullName
                                                    }}</div>
                                                <div class="text-xs text-gray-500 truncate">{{ user.email }}</div>
                                            </div>
                                            <svg *ngIf="interviewForm.interviewerId === user.id"
                                                class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </button>
                                        <div *ngIf="getFilteredInterviewersByRole('INTERVIEWER').length === 0"
                                            class="px-4 py-3 text-sm text-gray-500 text-center">
                                            Kh√¥ng t√¨m th·∫•y
                                        </div>
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div *ngIf="interviewers.length === 0 && !isLoadingInterviewers"
                                    class="px-4 py-8 text-center text-gray-500 text-sm">
                                    Kh√¥ng c√≥ ng∆∞·ªùi ph·ªèng v·∫•n kh·∫£ d·ª•ng
                                </div>
                            </div>
                        </div>

                        <!-- Click Outside to Close -->
                        <div *ngIf="isDropdownOpen" (click)="closeDropdown()" class="fixed inset-0 z-40"></div>

                        <p class="text-xs text-gray-500 mt-1"
                            *ngIf="!isLoadingInterviewers && interviewers.length === 0">
                            Kh√¥ng c√≥ Interviewer n√†o kh·∫£ d·ª•ng. Vui l√≤ng li√™n h·ªá Admin.
                        </p>
                    </div>

                    <!-- H√¨nh th·ª©c -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">H√¨nh th·ª©c *</label>
                        <select [(ngModel)]="interviewForm.type" (ngModelChange)="updateEmailPreview()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="ONLINE">Online (Video Call)</option>
                            <option value="OFFLINE">Offline (Tr·ª±c ti·∫øp)</option>
                        </select>
                    </div>

                    <!-- Link/ƒê·ªãa ƒëi·ªÉm -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ interviewForm.type === 'ONLINE' ? 'Link Meeting *' : 'ƒê·ªãa ƒëi·ªÉm *' }}
                        </label>
                        <input type="text" [(ngModel)]="interviewForm.location" (ngModelChange)="updateEmailPreview()"
                            [placeholder]="interviewForm.type === 'ONLINE' ? 'VD: https://meet.google.com/xxx' : 'VD: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1, TP.HCM'"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Khu v·ª±c Email Preview -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <!-- Header Email Preview -->
                    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-600">mail</span>
                            <span class="font-medium text-gray-700">So·∫°n th·∫£o Email Preview</span>
                        </div>
                        <button (click)="generateAIOpening()" [disabled]="isGeneratingAI"
                            class="px-4 py-2 bg-gradient-to-r from-yellow-400 to-amber-500 text-white rounded-lg hover:from-yellow-500 hover:to-amber-600 transition-all font-semibold text-sm flex items-center gap-2 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                            <span *ngIf="!isGeneratingAI">‚ú®</span>
                            <span *ngIf="isGeneratingAI" class="animate-spin">‚è≥</span>
                            {{ isGeneratingAI ? 'ƒêang t·∫°o...' : 'AI Personalize' }}
                        </button>
                    </div>

                    <!-- Textarea Email -->
                    <div class="p-4">
                        <textarea [(ngModel)]="emailPreviewContent" rows="10"
                            placeholder="N·ªôi dung email s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y..."
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none font-mono text-sm leading-relaxed"></textarea>
                        <p class="text-xs text-gray-500 mt-2">
                            üí° B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·ªôi dung email tr∆∞·ªõc khi g·ª≠i. B·∫•m "‚ú® AI Personalize" ƒë·ªÉ t·∫°o ƒëo·∫°n m·ªü
                            ƒë·∫ßu c√° nh√¢n h√≥a.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button (click)="closeInterviewModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                    H·ªßy
                </button>
                <button (click)="sendInterviewInvitation()" [disabled]="isSendingEmail || !isFormValid()"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span *ngIf="!isSendingEmail" class="material-symbols-outlined" style="font-size: 18px;">send</span>
                    <span *ngIf="isSendingEmail" class="animate-spin"></span>
                    {{ isSendingEmail ? 'ƒêang g·ª≠i...' : 'G·ª≠i l·ªùi m·ªùi' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Modal T·ª´ Ch·ªëi H·ªì S∆° -->
    <div *ngIf="showRejectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <span class="material-symbols-outlined text-red-500">cancel</span>
                    T·ª´ Ch·ªëi H·ªì S∆°
                </h2>
                <button (click)="closeRejectModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Th√¥ng tin ·ª©ng vi√™n -->
                <div class="bg-red-50 rounded-lg p-4 flex items-center gap-4">
                    <div class="h-12 w-12 rounded-full bg-red-100 flex items-center justify-center">
                        <span class="text-red-700 font-bold text-lg">{{
                            rejectApplication?.candidateName?.charAt(0)?.toUpperCase() }}</span>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900">{{ rejectApplication?.candidateName }}</p>
                        <p class="text-sm text-gray-600">{{ rejectApplication?.email }}</p>
                    </div>
                </div>

                <!-- B∆∞·ªõc 1: Input l√Ω do t·ª´ ch·ªëi -->
                <div *ngIf="rejectStep === 1" class="space-y-4">
                    <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-sm">B∆∞·ªõc 1</span>
                        Ch·ªçn l√Ω do t·ª´ ch·ªëi
                    </h3>

                    <!-- Checkboxes -->
                    <div class="space-y-3">
                        <label
                            class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" [(ngModel)]="rejectReasons.skill"
                                class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                            <span class="text-gray-700">Chuy√™n m√¥n ch∆∞a ƒë·∫°t</span>
                        </label>

                        <label
                            class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" [(ngModel)]="rejectReasons.salary"
                                class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                            <span class="text-gray-700">M·ª©c l∆∞∆°ng kh√¥ng ph√π h·ª£p</span>
                        </label>

                        <label
                            class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <input type="checkbox" [(ngModel)]="rejectReasons.culture"
                                class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                            <span class="text-gray-700">VƒÉn h√≥a kh√¥ng ph√π h·ª£p</span>
                        </label>
                    </div>

                    <!-- Ghi ch√∫ th√™m -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ghi ch√∫ th√™m cho AI</label>
                        <input type="text" [(ngModel)]="rejectNote"
                            placeholder="VD: Nh·∫π nh√†ng th√¥i, ƒë·ªông vi√™n h·ªç l·∫ßn sau..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>

                    <!-- N√∫t T·∫°o Draft -->
                    <button (click)="generateRejectionDraft()"
                        [disabled]="isGeneratingRejectEmail || !hasSelectedReason()"
                        class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all font-semibold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span *ngIf="!isGeneratingRejectEmail"></span>
                        <span *ngIf="isGeneratingRejectEmail" class="animate-spin">‚è≥</span>
                        {{ isGeneratingRejectEmail ? 'AI ƒëang so·∫°n email...' : 'T·∫°o Email nh√°p (AI Draft)' }}
                    </button>
                </div>

                <!-- B∆∞·ªõc 2: Review & Edit Email -->
                <div *ngIf="rejectStep === 2" class="space-y-4">
                    <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                        <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-sm">B∆∞·ªõc 2</span>
                        Xem l·∫°i & Ch·ªânh s·ª≠a Email
                    </h3>

                    <!-- Email Preview -->
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-600">mail</span>
                            <span class="text-sm font-medium text-gray-700">N·ªôi dung Email T·ª´ Ch·ªëi</span>
                        </div>
                        <textarea [(ngModel)]="rejectEmailContent" rows="12"
                            class="w-full px-4 py-3 border-0 focus:ring-0 resize-none font-mono text-sm leading-relaxed"></textarea>
                    </div>

                    <p class="text-xs text-gray-500">
                        B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·ªôi dung email tr∆∞·ªõc khi g·ª≠i. N·ªôi dung s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: <strong>{{
                            rejectApplication?.email }}</strong>
                    </p>

                    <!-- N√∫t quay l·∫°i -->
                    <button (click)="rejectStep = 1"
                        class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
                        <span class="material-symbols-outlined" style="font-size: 16px;">arrow_back</span>
                        Quay l·∫°i ch·ªçn l√Ω do
                    </button>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button (click)="closeRejectModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                    H·ªßy
                </button>
                <button *ngIf="rejectStep === 2" (click)="confirmReject()" [disabled]="isSendingRejectEmail"
                    class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span *ngIf="!isSendingRejectEmail" class="material-symbols-outlined"
                        style="font-size: 18px;">send</span>
                    <span *ngIf="isSendingRejectEmail" class="animate-spin">‚è≥</span>
                    {{ isSendingRejectEmail ? 'ƒêang g·ª≠i...' : 'G·ª≠i Email T·ª´ Ch·ªëi' }}
                </button>
            </div>
        </div>
    </div>
</div>
<app-offer-modal [isOpen]="isOfferModalOpen" [candidate]="selectedCandidateForOffer" (close)="isOfferModalOpen = false"
    (offerSent)="handleOfferSent($event)">
</app-offer-modal>